/* rgb2vga.c - convert rgb values to vga 256. */

/* Copyright (c) 2023 M. N. Yoshie */
/* Released under MIT License */

#include <math.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <assert.h>


#define F(x) ((float)x)

float ndx_vgapal[256][3] = {
    /* colors 0-15 */
    {F(0x00), F(0x00), F(0x00)},

    {F(0x00), F(0x00), F(0xAA)},
    {F(0x00), F(0xAA), F(0x00)},
    {F(0x00), F(0xAA), F(0xAA)},
    {F(0xAA), F(0x00), F(0x00)},
    {F(0xAA), F(0x00), F(0xAA)},

    {F(0xAA), F(0x55), F(0x00)},
    {F(0xAA), F(0xAA), F(0xAA)},
    {F(0x55), F(0x55), F(0x55)},
    {F(0x55), F(0x55), F(0xFF)},
    {F(0x55), F(0xFF), F(0x55)},

    {F(0x55), F(0xFF), F(0xFF)},
    {F(0xFF), F(0x55), F(0x55)},
    {F(0xFF), F(0x55), F(0xFF)},
    {F(0xFF), F(0xFF), F(0x55)},
    {F(0xFF), F(0xFF), F(0xFF)},

    /* grayscale 16-31 (non gamma corrected) */
    {F(0x00), F(0x00), F(0x00)},
    {F(0x14), F(0x14), F(0x14)},
    {F(0x20), F(0x20), F(0x20)},
    {F(0x2C), F(0x2C), F(0x2C)},
    {F(0x38), F(0x38), F(0x38)},

    {F(0x45), F(0x45), F(0x45)},
    {F(0x51), F(0x51), F(0x51)},
    {F(0x61), F(0x61), F(0x61)},
    {F(0x71), F(0x71), F(0x71)},
    {F(0x82), F(0x82), F(0x82)},

    {F(0x92), F(0x92), F(0x92)},
    {F(0xA2), F(0xA2), F(0xA2)},
    {F(0xB6), F(0xB6), F(0xB6)},
    {F(0xCB), F(0xCB), F(0xCB)},
    {F(0xE3), F(0xE3), F(0xE3)},

    {F(0xFF), F(0xFF), F(0xFF)},
    // HERE ------> 1
    /* hue mix 32-55 (1) */
    {F(0x00), F(0x00), F(0xFF)},
    {F(0x41), F(0x00), F(0xFF)},
    {F(0x7D), F(0x00), F(0xFF)},
    {F(0xBE), F(0x00), F(0xFF)},

    {F(0xFF), F(0x00), F(0xFF)},
    {F(0xFF), F(0x00), F(0xBE)},
    {F(0xFF), F(0x00), F(0x7D)},
    {F(0xFF), F(0x00), F(0x41)},
    {F(0xFF), F(0x00), F(0x00)},

    {F(0xFF), F(0x41), F(0x00)},
    {F(0xFF), F(0x7D), F(0x00)},
    {F(0xFF), F(0xBE), F(0x00)},
    {F(0xFF), F(0xFF), F(0x00)},
    {F(0xBE), F(0xFF), F(0x00)},

    {F(0x7D), F(0xFF), F(0x00)},
    {F(0x41), F(0xFF), F(0x00)},
    {F(0x00), F(0xFF), F(0x00)},
    {F(0x00), F(0xFF), F(0x41)},
    {F(0x00), F(0xFF), F(0x7D)},

    {F(0x00), F(0xFF), F(0xBE)},
    {F(0x00), F(0xFF), F(0xFF)},
    {F(0x00), F(0xBE), F(0xFF)},
    {F(0x00), F(0x7D), F(0xFF)},
    {F(0x00), F(0x41), F(0xFF)},

    /* hue mix 56-79 (2) */
    {F(0x7D), F(0x7D), F(0xFF)},
    {F(0x9E), F(0x7D), F(0xFF)},
    {F(0xBE), F(0x7D), F(0xFF)},
    {F(0xDF), F(0x7D), F(0xFF)},
    {F(0xFF), F(0x7D), F(0xFF)},

    {F(0xFF), F(0x7D), F(0xDF)},
    {F(0xFF), F(0x7D), F(0xBE)},
    {F(0xFF), F(0x7D), F(0x9E)},
    {F(0xFF), F(0x7D), F(0x7D)},
    {F(0xFF), F(0x9E), F(0x7D)},

    {F(0xFF), F(0xBE), F(0x7D)},
    {F(0xFF), F(0xDF), F(0x7D)},
    {F(0xFF), F(0xFF), F(0x7D)},
    {F(0xDF), F(0xFF), F(0x7D)},
    {F(0xBE), F(0xFF), F(0x7D)},

    {F(0x9E), F(0xFF), F(0x7D)},
    {F(0x7D), F(0xFF), F(0x7D)},
    {F(0x7D), F(0xFF), F(0x9E)},
    {F(0x7D), F(0xFF), F(0xBE)},
    {F(0x7D), F(0xFF), F(0xDF)},

    {F(0x7D), F(0xFF), F(0xFF)},
    {F(0x7D), F(0xDF), F(0xFF)},
    {F(0x7D), F(0xBE), F(0xFF)},
    {F(0x7D), F(0x9E), F(0xFF)},
    /* hue mix 80-103 (3) */
    {F(0xB6), F(0xB6), F(0xFF)},

    {F(0xC7), F(0xB6), F(0xFF)},
    {F(0xDB), F(0xB6), F(0xFF)},
    {F(0xEB), F(0xB6), F(0xFF)},
    {F(0xFF), F(0xB6), F(0xFF)},
    {F(0xFF), F(0xB6), F(0xEB)},

    {F(0xFF), F(0xB6), F(0xDB)},
    {F(0xFF), F(0xB6), F(0xC7)},
    {F(0xFF), F(0xB6), F(0xB6)},
    {F(0xFF), F(0xC7), F(0xB6)},
    {F(0xFF), F(0xDB), F(0xB6)},

    {F(0xFF), F(0xEB), F(0xB6)},
    {F(0xFF), F(0xFF), F(0xB6)},
    {F(0xEB), F(0xFF), F(0xB6)},
    {F(0xDB), F(0xFF), F(0xB6)},
    {F(0xC7), F(0xFF), F(0xB6)},

    {F(0xB6), F(0xFF), F(0xB6)},
    {F(0xB6), F(0xFF), F(0xC7)},
    {F(0xB6), F(0xFF), F(0xDB)},
    {F(0xB6), F(0xFF), F(0xEB)},
    {F(0xB6), F(0xFF), F(0xFF)},

    {F(0xB6), F(0xEB), F(0xFF)},
    {F(0xB6), F(0xDB), F(0xFF)},
    {F(0xB6), F(0xC7), F(0xFF)},
    // HERE ------> 2
    /* hue mix 104-127 (4) dark 1 */
    {F(0x00), F(0x00), F(0x71)},
    {F(0x1C), F(0x00), F(0x71)},
    {F(0x38), F(0x00), F(0x71)},
    {F(0x55), F(0x00), F(0x71)},

    {F(0x71), F(0x00), F(0x71)},
    {F(0x71), F(0x00), F(0x55)},
    {F(0x71), F(0x00), F(0x38)},
    {F(0x71), F(0x00), F(0x1C)},
    {F(0x71), F(0x00), F(0x00)},

    {F(0x71), F(0x1C), F(0x00)},
    {F(0x71), F(0x38), F(0x00)},
    {F(0x71), F(0x55), F(0x00)},
    {F(0x71), F(0x71), F(0x00)},
    {F(0x55), F(0x71), F(0x00)},

    {F(0x38), F(0x71), F(0x00)},
    {F(0x1C), F(0x71), F(0x00)},
    {F(0x00), F(0x71), F(0x00)},
    {F(0x00), F(0x71), F(0x1C)},
    {F(0x00), F(0x71), F(0x38)},

    {F(0x00), F(0x71), F(0x55)},
    {F(0x00), F(0x71), F(0x71)},
    {F(0x00), F(0x55), F(0x71)},
    {F(0x00), F(0x38), F(0x71)},
    {F(0x00), F(0x1C), F(0x71)},

    /* hue mix 56-79 (2) */
    {F(0x38), F(0x38), F(0x71)},
    {F(0x45), F(0x38), F(0x71)},
    {F(0x55), F(0x38), F(0x71)},
    {F(0x61), F(0x38), F(0x71)},
    {F(0x71), F(0x38), F(0x71)},

    {F(0x71), F(0x38), F(0x61)},
    {F(0x71), F(0x38), F(0x55)},
    {F(0x71), F(0x38), F(0x45)},
    {F(0x71), F(0x38), F(0x38)},
    {F(0x71), F(0x45), F(0x38)},

    {F(0x71), F(0x55), F(0x38)},
    {F(0x71), F(0x61), F(0x38)},
    {F(0x71), F(0x71), F(0x38)},
    {F(0x61), F(0x71), F(0x38)},
    {F(0x55), F(0x71), F(0x38)},

    {F(0x45), F(0x71), F(0x38)},
    {F(0x38), F(0x71), F(0x38)},
    {F(0x38), F(0x71), F(0x45)},
    {F(0x38), F(0x71), F(0x55)},
    {F(0x38), F(0x71), F(0x61)},

    {F(0x38), F(0x71), F(0x71)},
    {F(0x38), F(0x61), F(0x71)},
    {F(0x38), F(0x55), F(0x71)},
    {F(0x38), F(0x45), F(0x71)},
    /* hue mix 80-103 (3) */
    {F(0x51), F(0x51), F(0x71)},

    {F(0x59), F(0x51), F(0x71)},
    {F(0x61), F(0x51), F(0x71)},
    {F(0x69), F(0x51), F(0x71)},
    {F(0x71), F(0x51), F(0x71)},
    {F(0x71), F(0x51), F(0x69)},

    {F(0x71), F(0x51), F(0x61)},
    {F(0x71), F(0x51), F(0x59)},
    {F(0x71), F(0x51), F(0x51)},
    {F(0x71), F(0x59), F(0x51)},
    {F(0x71), F(0x61), F(0x51)},

    {F(0x71), F(0x69), F(0x51)},
    {F(0x71), F(0x71), F(0x51)},
    {F(0x69), F(0x71), F(0x51)},
    {F(0x61), F(0x71), F(0x51)},
    {F(0x59), F(0x71), F(0x51)},

    {F(0x51), F(0x71), F(0x51)},
    {F(0x51), F(0x71), F(0x59)},
    {F(0x51), F(0x71), F(0x61)},
    {F(0x51), F(0x71), F(0x69)},
    {F(0x51), F(0x71), F(0x71)},

    {F(0x51), F(0x69), F(0x71)},
    {F(0x51), F(0x61), F(0x71)},
    {F(0x51), F(0x59), F(0x71)},
    // HERE ------> 3
    /* hue mix 104-127 (4) dark 1 */
    {F(0x00), F(0x00), F(0x41)},
    {F(0x10), F(0x00), F(0x41)},
    {F(0x20), F(0x00), F(0x41)},
    {F(0x30), F(0x00), F(0x41)},

    {F(0x41), F(0x00), F(0x41)},
    {F(0x41), F(0x00), F(0x30)},
    {F(0x41), F(0x00), F(0x20)},
    {F(0x41), F(0x00), F(0x10)},
    {F(0x41), F(0x00), F(0x00)},

    {F(0x41), F(0x10), F(0x00)},
    {F(0x41), F(0x20), F(0x00)},
    {F(0x41), F(0x30), F(0x00)},
    {F(0x41), F(0x41), F(0x00)},
    {F(0x30), F(0x41), F(0x00)},

    {F(0x20), F(0x41), F(0x00)},
    {F(0x10), F(0x41), F(0x00)},
    {F(0x00), F(0x41), F(0x00)},
    {F(0x00), F(0x41), F(0x10)},
    {F(0x00), F(0x41), F(0x20)},

    {F(0x00), F(0x41), F(0x30)},
    {F(0x00), F(0x41), F(0x41)},
    {F(0x00), F(0x30), F(0x41)},
    {F(0x00), F(0x20), F(0x41)},
    {F(0x00), F(0x10), F(0x41)},

    /* hue mix 56-79 (2) */
    {F(0x20), F(0x20), F(0x41)},
    {F(0x28), F(0x20), F(0x41)},
    {F(0x30), F(0x20), F(0x41)},
    {F(0x3C), F(0x20), F(0x41)},
    {F(0x41), F(0x20), F(0x41)},

    {F(0x41), F(0x20), F(0x3C)},
    {F(0x41), F(0x20), F(0x30)},
    {F(0x41), F(0x20), F(0x28)},
    {F(0x41), F(0x20), F(0x20)},
    {F(0x41), F(0x28), F(0x20)},

    {F(0x41), F(0x30), F(0x20)},
    {F(0x41), F(0x3C), F(0x20)},
    {F(0x41), F(0x41), F(0x20)},
    {F(0x3C), F(0x41), F(0x20)},
    {F(0x30), F(0x41), F(0x20)},

    {F(0x28), F(0x41), F(0x20)},
    {F(0x20), F(0x41), F(0x20)},
    {F(0x20), F(0x41), F(0x28)},
    {F(0x20), F(0x41), F(0x30)},
    {F(0x20), F(0x41), F(0x3C)},

    {F(0x20), F(0x41), F(0x41)},
    {F(0x20), F(0x3C), F(0x41)},
    {F(0x20), F(0x30), F(0x41)},
    {F(0x20), F(0x28), F(0x41)},
    /* hue mix 80-103 (3) */
    {F(0x2C), F(0x2C), F(0x41)},

    {F(0x30), F(0x2C), F(0x41)},
    {F(0x34), F(0x2C), F(0x41)},
    {F(0x3C), F(0x2C), F(0x41)},
    {F(0x41), F(0x2C), F(0x41)},
    {F(0x41), F(0x2C), F(0x3C)},

    {F(0x41), F(0x2C), F(0x34)},
    {F(0x41), F(0x2C), F(0x30)},
    {F(0x41), F(0x2C), F(0x2C)},
    {F(0x41), F(0x30), F(0x2C)},
    {F(0x41), F(0x34), F(0x2C)},

    {F(0x41), F(0x3C), F(0x2C)},
    {F(0x41), F(0x41), F(0x2C)},
    {F(0x3C), F(0x41), F(0x2C)},
    {F(0x34), F(0x41), F(0x2C)},
    {F(0x30), F(0x41), F(0x2C)},

    {F(0x2C), F(0x41), F(0x2C)},
    {F(0x2C), F(0x41), F(0x30)},
    {F(0x2C), F(0x41), F(0x34)},
    {F(0x2C), F(0x41), F(0x3C)},
    {F(0x2C), F(0x41), F(0x41)},

    {F(0x2C), F(0x3C), F(0x41)},
    {F(0x2C), F(0x34), F(0x41)},
    {F(0x2C), F(0x30), F(0x41)},

    /* all black */
    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},

    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},
    {F(0), F(0), F(0)},

};

typedef struct pixel_t pixel_t;
struct pixel_t {
  float r, g, b;
};

uint8_t rgb2vga(int r, int g, int b) {
  float rf = (float)r, gf = (float)g, bf = (float)b;
  float closest = +INFINITY;
  int ndx = 0, done = 0;
  // This is slow. For some reasons, those pragmas made it extra slow.
  //  #pragma omp parallel for
  for (int i = 0; i < 248; i++) {
    //    if (done) continue;
    float *sample = ndx_vgapal[i];
    float rs = sample[0];
    float gs = sample[1];
    float bs = sample[2];
    float dst =
        (rs - rf)*(rs - rf) + (gs - gf)*(gs - gf) + (bs - bf)*(bs - bf);
    //   #pragma omp critical
    {
      if (closest > dst) {
        closest = dst;
        ndx = i;
      } else if (dst < 0.05) {
        done = 1;
        ndx = i;
        break;
      }
    }
  }
  return (uint8_t)ndx;
}

pixel_t rgbgvga(float r, float g, float b) {
  float rf = (float)r, gf = (float)g, bf = (float)b;
  float closest = +INFINITY;
  int ndx = 0, done = 0;
  // This is slow. For some reasons, those pragmas made it extra slow.
  //  #pragma omp parallel for
  for (int i = 0; i < 248; i++) {
    //    if (done) continue;
    float *sample = ndx_vgapal[i];
    float rs = sample[0];
    float gs = sample[1];
    float bs = sample[2];
    float dst =
        (rs - rf)*(rs - rf) + (gs - gf)*(gs - gf) + (bs - bf)*(bs - bf);
    //   #pragma omp critical
    {
      if (closest > dst) {
        closest = dst;
        ndx = i;
      } else if (dst < 0.05) {
        done = 1;
        ndx = i;
        break;
      }
    }
  }
  return (pixel_t){ndx_vgapal[ndx][0],ndx_vgapal[ndx][1],ndx_vgapal[ndx][2]} ;
}

int width, height;
int pixel_ndx(int x, int y){
  return x + y*width;
}
int main(int argc, char *argv[]) {
  FILE *fp = stdin;

  if (argc == 3){
    width = atoi(argv[1]);
    height = atoi(argv[2]);
    assert(width > 0 && height > 0);
    pixel_t *pixels = calloc(sizeof(pixel_t), width*height);
    int ctr = 0;
    while (!feof(fp) && width*height > ctr) {
      int r = getc(fp);
      int g = getc(fp);
      int b = getc(fp);
      pixels[ctr].r = (float)r;
      pixels[ctr].g = (float)g;
      pixels[ctr].b = (float)b;
      ctr++;
    }
    for (int y = 1; y < height - 1; y++)
      for (int x = 1; x < width - 1; x++) {
	pixel_t opixel = pixels[pixel_ndx(x,y)];
	pixel_t npixel = rgbgvga(opixel.r, opixel.g, opixel.b);
	pixels[pixel_ndx(x,y)] = npixel;
	float rqerr = (float)opixel.r - (float)npixel.r;
	float gqerr = (float)opixel.g - (float)npixel.g;
	float bqerr = (float)opixel.b - (float)npixel.b;

	pixels[pixel_ndx(x + 1, y)].r = ((float)pixels[pixel_ndx(x + 1,y)].r +
          (rqerr*7.0/16.0));
	pixels[pixel_ndx(x + 1, y)].g = ((float)pixels[pixel_ndx(x + 1,y)].g +
          (gqerr*7.0/16.0));
	pixels[pixel_ndx(x + 1, y)].b = ((float)pixels[pixel_ndx(x + 1,y)].b +
          (bqerr*7.0/16.0));


	pixels[pixel_ndx(x - 1, y + 1)].r = ((float)pixels[pixel_ndx(x - 1,y + 1)].r +
          (rqerr*3.0/16.0));
	pixels[pixel_ndx(x - 1, y + 1)].g = ((float)pixels[pixel_ndx(x - 1,y + 1)].g +
          (gqerr*3.0/16.0));
	pixels[pixel_ndx(x - 1, y + 1)].b = ((float)pixels[pixel_ndx(x - 1,y + 1)].b +
          (bqerr*3.0/16.0));

	pixels[pixel_ndx(x, y + 1)].r = ((float)pixels[pixel_ndx(x,y + 1)].r +
          (rqerr*5.0/16.0));
	pixels[pixel_ndx(x, y + 1)].g = ((float)pixels[pixel_ndx(x,y + 1)].g +
          (gqerr*5.0/16.0));
	pixels[pixel_ndx(x, y + 1)].b = ((float)pixels[pixel_ndx(x,y + 1)].b +
          (bqerr*5.0/16.0));

	pixels[pixel_ndx(x + 1, y + 1)].r = ((float)pixels[pixel_ndx(x + 1,y + 1)].r +
          (rqerr/16.0));
	pixels[pixel_ndx(x + 1, y + 1)].g = ((float)pixels[pixel_ndx(x + 1,y + 1)].g +
          (gqerr/16.0));
	pixels[pixel_ndx(x + 1, y + 1)].b = ((float)pixels[pixel_ndx(x + 1,y + 1)].b +
          (bqerr/16.0));
      }
    for (int i = 0; i < width*height; i++){
      putchar(rgb2vga((uint8_t)pixels[i].r,(uint8_t)pixels[i]. g, (uint8_t)pixels[i].b));
    }

    free(pixels);

  } else {
    while (!feof(fp)) {
      int r = getc(fp);
      int g = getc(fp);
      int b = getc(fp);
      putchar(rgb2vga(r, g, b));
    }
  }
  return 0;
}
